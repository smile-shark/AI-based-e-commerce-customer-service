我现在在做一个关于AI电商客服的项目

设定的功能主要是这些：
* 商品查询 Tool（对接模拟电商 API）
* 知识库 RAG（1000+ 商品政策与常见问题文档）
* 客服角色设定 + 专业提示词模板
* 多用户会话 + Redis短期记忆 + MySQL对话长期记忆
* 敏感词 + 情绪感应 + 自动转人工

但是我现在需要理清一下流程，下面是我写的具体流程，请你帮我写一个`excalidraw`的流程图

**商户部分**

商品部分：
1. 商户添加对应的商品
2. 进入对应的商品页面开始上传对应商品的描述文档等等
3. 文档会经过拆分再经过向量模型向量化最后存入对应的向量数据库

AI客服部分：
1. 配置AI客服（可以配置一些可以动态调整的细节，比如对AI客服的角色描述、问候语、回复语调...）

**客户部分**
商品部分：
1. 显示商品的列表
2. 用户点击对应的商品，进入对应的聊天页面
3. 用户发送第一条消息，表示在后端建立一个会话
4. 后端会根据客户的id和商品的id查询到对应的商家id，并建立一个会话
5. 会话拥有一个状态，状态分为('AI', 'HUMAN')表示是AI或者是人工的回答
6. 如果这个商户没有配置过AI客服，那么就选择人工，否则使用默认（AI）
   1. 如果没有配置AI，就会将对应的消息存储到数据库中
   2. 同时会检测商户是否在线，如果在线就会直接将对应的消息推送给商户
   3. 商户进入看见客户的消息后可以进行回复，客户端同样如此
7. 如果这个商户配置了AI客服，那么就会使用AI客服进行回答
8. 首先会通过用户发送的消息通过RAG检索向量数据库中对应商品的文档
9. 然后AI会根据商户上传的文档对客户的问题进行一个回答
10. AI的记忆部分会设置为最多10条的上下文记忆，主要是从Reids中进行存储和获取，redis中也不可能永永久存储，所以需要先通过会话的id确认目前聊天的是AI还是人工，如果是人工就不想要RAG，也不需要从Reids中获取记忆
11. 长期的记忆会由MySql进行存储，MySql中也会存储人工的消息
12. 其中会添加一些敏感词检测/情绪检测的方案，确定是否需要介入人工服务 
13. 当需要介入人工服务是就会使用上面没有配置AI客服时的流程进行，并将会话的状态从AI修改为HUMAN

如果有什么不明白的地方可以向我提问

---

客户进入到主页后首先会看见商品的列表，现在商品已经有了一个分页接口，客户点击“问客服”后进入对应的聊天页面，当用户发送第一句话的时候后端接收请求（其中包含，该商品的id，商户的id，客户id以及对应的用户发送的信息）

**后端接收流程：**
1. 后端接收到对应的数据
2. 判断是否有对应的sessionId，如果没有就表示是第一次对话
   1. 使用对应的商户id查询该商户是否开启了AI客服服务
   2. 创建一个对应的session（开启AI服务使用默认状体，否则使用人工服务状态）
3. 如果有sessionId就查询对应的session判断该会话是通过AI还是人工

* 通过AI客服：
  1. 使用AI模型对客户问题进行分析
     * 走人工服务的情况：
        1. 分析关键词中是否要求人工服务
        2. 分析用户当前的情绪，如果情绪过低就进行人工服务
  2. 从Redis中检索到对应的上下文
  3. 如果Redis中没有就查询MySQL中该会话的上下文，并将其缓存到Redis中
  4. 再通过RAG检索到对应商品文档
  5. 判断是否需要转人工（比如出现商品文档中没有的情况）
     * 如果需要走人工就使用通过人工服务的流程
  6. 确定AI回答
  7. 更新Redis中的短期记忆
  8. 同步MySQL中的长期记忆
  9. 返回响应给客户

> socket的连接建立也应该是在用户登录进入的时候，毕竟可能需要通过socket接收之前商户发送的消息
> 
> 所以这里的走人工通道应该是需要在前端记录对应session的状态就行了
* 通过人工服务：
    > 按道理来说一般到了这个位置都不会是人工，如果是人工的情况估计是蓄意的
  1. 通过sessionId获取对应的socket连接
  2. 将对应的消息存入到数据库中
     1. 找到对应的连接就将其发送
  3. 返回通过人工的状态，让前端使用socket连接实时接收消息
  > 注意：在转人工的时候需要将对应的会话上的id放到redis中方便对话房间分隔

**后续通过人工聊天的过程：**

副线：（socket连接建立）
   1. 商户登录到主页的时候就进行socket连接
   2. 客户在转人工或进入会话时本身就是人工服务时建立连级
   3. 通过sessionId查询到对应的商户id/客户id

客户=>商户：
1. 接收对应数据，通过sessionId找到商户的id
2. 将消息存入到mysql中
3. 如果有对应商户的连接，就发送对应的消息

商户=>客户：
1. 接收对应数据，通过sessionId找到客户的id
2. 将消息存入到mysql中
3. 如果有对应客户的连接，就发送对应的消息