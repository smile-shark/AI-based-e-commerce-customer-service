<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 电商客服流程图编辑器 (成本优化版)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        #editor {
            font-family: 'Fira Code', monospace;
            resize: none;
        }
        .mermaid-container {
            background-color: #f8fafc;
            border-radius: 8px;
            cursor: grab;
        }
        .mermaid-container:active {
            cursor: grabbing;
        }
        #graphContainer svg {
            max-width: none !important;
            width: 100%;
            height: 100%;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
<!-- 头部 -->
<header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-20">
    <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold text-gray-800">AI 电商客服流程图编辑器</h1>
        <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded">成本优化：先判状态，再拉记忆</span>
    </div>
    <div class="space-x-2 flex items-center">
        <button id="resetZoomBtn" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm transition">
            适应屏幕
        </button>
        <button id="renderBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
            重新渲染
        </button>

        <div class="relative inline-block dropdown">
            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium inline-flex items-center">
                <span>导出图片</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="dropdown-menu absolute right-0 hidden pt-2 w-32 z-30">
                <div class="bg-white border shadow-xl rounded-lg overflow-hidden">
                    <button onclick="exportImage('png')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出 PNG</button>
                    <button onclick="exportImage('jpg')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出 JPG</button>
                </div>
            </div>
        </div>

        <button id="downloadBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition text-sm">
            复制源码
        </button>
    </div>
</header>

<!-- 主体 -->
<main class="flex-1 flex overflow-hidden p-4 gap-4">
    <!-- 编辑区 -->
    <div class="w-1/3 flex flex-col bg-white rounded-xl shadow-sm border overflow-hidden">
        <div class="bg-gray-50 px-4 py-2 border-b text-sm font-medium text-gray-500 flex justify-between">
            <span>Mermaid 源码编辑器</span>
        </div>
        <textarea id="editor" class="flex-1 p-4 outline-none text-sm leading-relaxed text-gray-700">graph TD
    %% 样式定义
    classDef merchant fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef customer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;
    classDef ai_logic fill:#fff3e0,stroke:#e65100,stroke-width:2px,stroke-dasharray: 5 5;
    classDef database fill:#f1f8e9,stroke:#33691e,stroke-width:2px;

    subgraph Merchant_Section [商户管理端]
        M1[添加商品] --> M2[上传商品描述/政策文档]
        M2 --> M3{RAG 预处理}
        M3 -->|拆分/向量化| M4[(向量数据库)]
        M5[配置 AI 客服设置] -->|角色/语调/问候语| M6[(MySQL: 客服配置表)]
    end

    subgraph Customer_Section [用户客户端]
        C1[浏览商品列表] --> C2[点击商品进入聊天]
        C2 --> C3[发送消息]
        C3 --> C4[后端获取会话 Session]

        C4 --> C5{查询商户配置}
        C5 -->|未配置 AI| S_Human[进入人工模式]
        C5 -->|已配置 AI| A0[敏感词 & 情绪预检]

        %% 第一层：安全与分流判断（零 Token 消耗点）
        A0 -->|检测异常| ChangeToHuman[修改 Session 为 HUMAN]
        ChangeToHuman --> S_Human
        A0 -->|检测正常| A1{查询会话当前状态}

        A1 -->|Status: HUMAN| S_Human

        %% 第二层：AI 核心链路（按需加载资源）
        A1 -->|Status: AI| A2[从 Redis 获取近期记忆 - Top 10]

        A2 --> A3[RAG: 检索向量数据库相关文档]
        A3 --> A4[LLM 生成回答 - 注入记忆与文档]

        A4 --> A5{LLM 逻辑判断}
        A5 -->|判定需转人工| ChangeToHuman
        A5 -->|确认 AI 回答| A6[更新 Redis 短期记忆]

        A6 --> A7[同步至 MySQL 长期记忆]
        A7 --> A8[返回响应给客户]

        %% 人工模式流程
        S_Human --> H1[消息同步写入 MySQL]
        H1 --> H2{商户状态?}
        H2 -->|在线| H3[WebSocket 推送商户]
        H2 -->|离线| H4[转为留言工单]
        H3 --> H5[商户/客户双向实时聊天]
    end

    %% 关系标注
    class M1,M2,M3,M5 merchant;
    class C1,C2,C3,C4 customer;
    class A0,A2,A3,A4,A5 ai_logic;
    class M4,M6,H1,A7 database;</textarea>
    </div>

    <!-- 预览区 -->
    <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border overflow-hidden relative">
        <div class="bg-gray-50 px-4 py-2 border-b text-sm font-medium text-gray-500">可视化预览 (优化后的逻辑链路)</div>
        <div id="preview" class="flex-1 mermaid-container">
            <div id="graphContainer" class="w-full h-full flex items-center justify-center">
            </div>
        </div>
        <div class="absolute bottom-4 right-4 bg-white/80 backdrop-blur shadow border rounded px-3 py-1 text-xs text-gray-500 pointer-events-none">
            滚轮缩放 · 鼠标拖拽
        </div>
    </div>
</main>

<script>
    let panZoomInstance = null;

    mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        flowchart: { useMaxWidth: false, htmlLabels: true }
    });

    const editor = document.getElementById('editor');
    const container = document.getElementById('graphContainer');
    const renderBtn = document.getElementById('renderBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');

    async function renderGraph() {
        const code = editor.value;
        if (panZoomInstance) {
            panZoomInstance.destroy();
            panZoomInstance = null;
        }
        container.innerHTML = `<div class="mermaid">${code}</div>`;
        try {
            await mermaid.run({ nodes: [container.querySelector('.mermaid')] });
            const svgElement = container.querySelector('svg');
            if (svgElement) {
                svgElement.style.height = "100%";
                svgElement.style.width = "100%";
                panZoomInstance = svgPanZoom(svgElement, {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: true,
                    center: true,
                    minZoom: 0.1,
                    maxZoom: 10
                });
            }
        } catch (err) { console.error("渲染错误:", err); }
    }

    async function exportImage(format) {
        const svgElement = container.querySelector('svg');
        if (!svgElement) return;

        const bbox = svgElement.getBBox();
        const width = bbox.width + 40;
        const height = bbox.height + 40;

        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);

        if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
            source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
        }

        const svgBase64 = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
        const img = new Image();
        img.crossOrigin = "anonymous";

        img.onload = function() {
            try {
                const canvas = document.createElement('canvas');
                const scale = 2;
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.scale(scale, scale);
                ctx.drawImage(img, 20 - bbox.x, 20 - bbox.y);

                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const dataUrl = canvas.toDataURL(mimeType, 0.9);
                const link = document.createElement('a');
                link.download = `AI电商客服流程图_成本优化版.${format}`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error("导出失败:", e);
            }
        };
        img.src = svgBase64;
    }

    renderBtn.addEventListener('click', renderGraph);
    resetZoomBtn.addEventListener('click', () => {
        if (panZoomInstance) {
            panZoomInstance.fit();
            panZoomInstance.center();
        }
    });

    downloadBtn.addEventListener('click', () => {
        const code = editor.value;
        const tempInput = document.createElement('textarea');
        tempInput.value = code;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);

        const originalText = downloadBtn.innerText;
        downloadBtn.innerText = '已复制!';
        downloadBtn.classList.replace('bg-gray-600', 'bg-green-600');
        setTimeout(() => {
            downloadBtn.innerText = originalText;
            downloadBtn.classList.replace('bg-green-600', 'bg-gray-600');
        }, 2000);
    });

    window.onload = renderGraph;
</script>
</body>
</html>